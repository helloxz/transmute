<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ siteInfo.title }} - {{siteInfo.sub_title}}</title>
    <meta name="keywords" content="{{ siteInfo.keywords }}">
    <meta name="description" content="{{ siteInfo.description }}">
    <!-- 引入Element UI的CSS -->
    <link rel="stylesheet" href="/static/element-ui/index.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="icon" href="/static/images/favicon.ico" type="image/x-icon">
</head>
<body>
    <div id="app">
        <!-- 顶部栏 -->
        <div class="header">
            <div class="left">
                <a href="/" class="logo">
                    <svg t="1742181274976" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4549" width="26" height="26"><path d="M799.524571 560.761905v37.059047H902.095238v178.712381h-102.570667v79.238096H736.792381v-79.238096H633.904762v-178.712381h102.887619V560.761905h62.73219zM828.952381 146.285714a73.142857 73.142857 0 0 1 73.142857 73.142857v341.333334h-48.761905v-48.761905h-170.666666v48.761905h-97.52381v170.617905l-105.715809 0.02438-163.742477 118.613334a24.380952 24.380952 0 0 1-38.692571-19.748572V731.428571L195.047619 731.428571a73.142857 73.142857 0 0 1-73.142857-73.142857V219.428571a73.142857 73.142857 0 0 1 73.142857-73.142857h633.904762z m-93.184 494.933334h-42.812952v80.457142h42.812952v-80.457142z m107.105524 0H800.426667v80.457142h42.471619v-80.457142zM545.401905 292.571429h-91.428572L390.095238 530.895238h65.048381l11.093333-46.470095h66.852572l11.093333 46.470095H609.52381L545.377524 292.571429z m-45.275429 51.858285l21.601524 92.038096H477.622857l21.894095-92.038096h0.585143z" p-id="4550" fill="#409EFF"></path></svg> 
                    &nbsp;<h1 style="font-size:22px;">{{ siteInfo.title }}</h1>
                </a>
                <h2 style="font-size:13px;color:#909399;padding:2px 0 2px 3px;">{{ siteInfo.sub_title }}</h2>
            </div>
            <div class="right">
                <a href="https://github.com/helloxz/transmute" title="Transmute项目地址" rel="nofollow" target="_blank" class="github-link">
                    <svg t="1742181565527" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5570" width="28" height="28"><path d="M512 12.64c-282.752 0-512 229.216-512 512 0 226.208 146.72 418.144 350.144 485.824 25.6 4.736 35.008-11.104 35.008-24.64 0-12.192-0.48-52.544-0.704-95.328-142.464 30.976-172.512-60.416-172.512-60.416-23.296-59.168-56.832-74.912-56.832-74.912-46.464-31.776 3.52-31.136 3.52-31.136 51.392 3.616 78.464 52.768 78.464 52.768 45.664 78.272 119.776 55.648 148.992 42.56 4.576-33.088 17.856-55.68 32.512-68.48-113.728-12.928-233.28-56.864-233.28-253.024 0-55.904 20-101.568 52.768-137.44-5.312-12.896-22.848-64.96 4.96-135.488 0 0 43.008-13.76 140.832 52.48 40.832-11.36 84.64-17.024 128.16-17.248 43.488 0.192 87.328 5.888 128.256 17.248 97.728-66.24 140.64-52.48 140.64-52.48 27.872 70.528 10.336 122.592 5.024 135.488 32.832 35.84 52.704 81.536 52.704 137.44 0 196.64-119.776 239.936-233.792 252.64 18.368 15.904 34.72 47.04 34.72 94.816 0 68.512-0.608 123.648-0.608 140.512 0 13.632 9.216 29.6 35.168 24.576 203.328-67.776 349.856-259.616 349.856-485.76 0-282.784-229.248-512-512-512z" fill="#444444" p-id="5571"></path></svg>
                </a>
            </div>
        </div>
        
        <!-- 主要内容区域 -->
        <div class="content">
            
            <!-- 翻译输入模块 -->
            <div class="translate-container">
                <div class="language-selector">
                    <el-row :gutter="20">
                        <el-col :xs="9" :sm="10">
                            <el-select disabled v-model="sourceLanguage" placeholder="选择源语言" style="width: 100%">
                                <el-option label="自动检测" :value="'auto'"></el-option>
                            </el-select>
                        </el-col>
                        <el-col :xs="6" :sm="4">
                            <div class="switch">
                                <?xml version="1.0" encoding="UTF-8"?><svg width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M42 19H5.99998" stroke="#9b9b9b" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/><path d="M30 7L42 19" stroke="#9b9b9b" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/><path d="M6.79897 29H42.799" stroke="#9b9b9b" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/><path d="M6.79895 29L18.799 41" stroke="#9b9b9b" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </div>
                        </el-col>
                        <el-col :xs="9" :sm="10">
                            <el-select v-model="targetLanguage" placeholder="选择目标语言" style="width: 100%">
                                <el-option v-for="item in languages" :key="item.value" :label="item.name" :value="item.value"></el-option>
                            </el-select>
                        </el-col>
                    </el-row>
                </div>

                <!-- 内容输入框 -->
                <div class="textarea-container" @keydown="quickTranslate">
                    <el-input
                        type="textarea"
                        v-model="inputText"
                        :autosize="{ minRows: 6, maxRows: 10 }"
                        placeholder="请输入要翻译的内容..."
                        show-word-limit
                        minlength="2"
                        maxlength="3000"
                        :autofocus="true"
                    ></el-input>
                    <!-- <div class="char-count">{{ charCount }}/5000</div> -->
                </div>
                
                <!-- AI模型选择和提交按钮 -->
                <el-row :gutter="20">
                    <el-col :xs="12" :sm="12">
                        <div class="input-left-btns">
                            <el-select size="small" @change="setModel" v-model="selectedModel" placeholder="选择AI模型" style="width: 100%">
                                <el-option v-for="model in models" :key="model.model" :label="model.name" :value="model.model"></el-option>
                            </el-select>
                        </div>
                    </el-col>
                    <el-col :xs="12" :sm="12">
                        <div class="input-right-btns">
                            <el-button
                                type="primary"
                                icon="el-icon-delete"
                                circle
                                @click="inputText = ''; translationResult = '';"
                                :disabled="!inputText.trim()"
                                size="mini"
                                title="清空输入和结果"
                            >

                            </el-button>
                            <el-button 
                                type="primary" 
                                @click="translate" 
                                :loading="isLoading" 
                                size="mini"
                                icon="el-icon-top"
                                round
                                title="开始翻译"
                                :disabled="!inputText.trim() || charCount > 5000">
                                翻译
                            </el-button>
                        </div>
                    </el-col>
                </el-row>
            </div>
            
            <!-- 翻译结果模块 -->
            <div class="result-container">
                <el-input
                    type="textarea"
                    :autosize="{ minRows: 6, maxRows: 10 }"
                    placeholder="翻译结果"
                    v-model="translationResult"
                    readonly
                ></el-input>

                <!-- 复制结果按钮 -->
                <div class="result-btns">
                    <a title="复制翻译结果" style="font-size:20px;color:#67C23A;" href="javascript:;" @click="copy(translationResult)"><i class="el-icon-copy-document"></i></a>
                    <!-- <el-button size="mini" plain circle icon="el-icon-copy-document" type="primary" @click="copy" :disabled="!translationResult.trim()"></el-button> -->
                </div>
                <!-- 复制结果按钮END -->
            </div>

            
        </div>
        
        <!-- 底部版权信息 -->
        <div class="footer">
            <p>© 2025 {{ siteInfo.title }}. All Rights Reserved. Powered by <a rel="nofollow" href="https://github.com/helloxz/transmute" target="_blank" rel="noopener noreferrer">Transmute</a></p>
        </div>
    </div>

    <!-- 引入Vue和Element UI的JS -->
    <script src="/static/js/vue.min.js"></script>
    <script src="/static/element-ui/index.js"></script>
    <script src="/static/js/axios.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    sourceLanguage: 'auto',
                    targetLanguage: 'auto',
                    inputText: '',
                    selectedModel: '',
                    translationResult: '',
                    isLoading: false,
                    charCount: 0,
                    languages: [
                        { value: 'auto', name: '自动检测' }
                    ],
                    models: [
                        
                    ]
                }
            },
            methods: {
                // ctrl + enter或者cmd + enter快捷键提交翻译
                quickTranslate(event) {
                    // 检测 Ctrl+Enter 或 Cmd+Enter
                    if ((event.ctrlKey || event.metaKey) && event.keyCode === 13) {
                        event.preventDefault(); // 阻止默认的换行行为
                        this.translate();
                    }
                    if (event.key === 'Escape') {
                        // 清空输入和输出
                        this.inputText = '';
                        this.translationResult = '';
                    }
                },
                setModel(){
                    console.log(this.selectedModel);
                    // 把选择的模型值存储到浏览器的localStorage中
                    localStorage.setItem('selectedModel', this.selectedModel);
                },
                copy(text) {
                    // 如果结果是空的
                    if (!text.trim()) {
                        this.$message({
                            message: '没有要复制的内容',
                            type: 'warning',
                        });
                        return;
                    }
                    try {
                        // 创建临时textarea元素
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        
                        // 确保元素不可见
                        textArea.style.position = 'fixed';
                        textArea.style.top = '0';
                        textArea.style.left = '0';
                        textArea.style.width = '2em';
                        textArea.style.height = '2em';
                        textArea.style.padding = '0';
                        textArea.style.border = 'none';
                        textArea.style.outline = 'none';
                        textArea.style.boxShadow = 'none';
                        textArea.style.background = 'transparent';
                        
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        
                        const successful = document.execCommand('copy');
                        document.body.removeChild(textArea);
                        
                        if (successful) {
                            this.$message({
                                message: '结果已复制',
                                type: 'success',
                            });
                        } else {
                            this.$message({
                                message: '复制失败',
                                type: 'error',
                            });
                        }
                    } catch (err) {
                        this.$message({
                            message: '复制失败: ' + err,
                            type: 'error',
                        });
                    }
                },
                getLanguages(){
                    axios.get('/api/get/languages')
                    .then(response => {
                        if( response.data.code == 200){
                            this.languages = response.data.data;
                        }
                    })
                    .catch(error => {
                        this.$message.error('获取语言列表失败');
                        console.log(error);
                    });
                },
                getModels(){
                    axios.get('/api/get/models')
                    .then(response => {
                        if( response.data.code == 200){
                            this.models = response.data.data;
                            // 从localStorage中获取上次选择的模型值
                            const selectedModel = localStorage.getItem('selectedModel');
                            if(selectedModel){
                                this.selectedModel = selectedModel;
                            }
                            else{
                                this.selectedModel = this.models[0].model;
                            }
                        }
                    })
                    .catch(error => {
                        this.$message.error('获取AI模型列表失败');
                        console.log(error);
                    });
                },
                updateCharCount() {
                    this.charCount = this.inputText.length;
                },
                translate() {
                    // 如果loading状态为true，说明正在翻译中，不允许再次提交
                    if (this.isLoading) return;
                    if (!this.inputText.trim()) {
                        this.$message.warning('请输入要翻译的内容');
                        return;
                    }
                    
                    if (this.charCount > 5000) {
                        this.$message.error('输入内容不能超过5000个字符');
                        return;
                    }
                    
                    this.isLoading = true;
                    this.translationResult = '';
                    
                    const payload = {
                        target_language: this.targetLanguage,
                        model: this.selectedModel,
                        input: this.inputText
                    };
                    
                    fetch('/api/translate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('网络响应错误');
                        }
                        // 如果状态码是500
                        if (response.status === 500) {
                            this.$message.error('服务器错误，请稍后再试');
                            this.isLoading = false;
                            return;
                        }
                        const contentType = response.headers.get('Content-Type');
                        if (contentType && contentType.includes('application/json')) {
                            response.json()
                            .then(jsonData => {
                                if (jsonData.code != 200) {
                                    console.log(jsonData);
                                    this.$message.error(jsonData.msg);
                                    this.isLoading = false;
                                    return;
                                }
                            })
                            return;
                        }
                        
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder('utf-8');
                        let buffer = '';
                        
                        const processStream = () => {
                            return reader.read().then(({ done, value }) => {
                                if (done) {
                                    this.isLoading = false;
                                    return;
                                }
                                
                                buffer += decoder.decode(value, { stream: true });
                                const lines = buffer.split('\n');
                                buffer = lines.pop() || '';
                                
                                for (const line of lines) {
                                    if (line.trim() === '') continue;
                                    
                                    if (line.includes('[DONE]')) {
                                        this.isLoading = false;
                                        continue;
                                    }
                                    
                                    if (line.startsWith('data:')) {
                                        try {
                                            const jsonStr = line.substring(5).trim();
                                            const data = JSON.parse(jsonStr);
                                            if (data.value !== undefined) {
                                                this.translationResult += data.value;
                                            }
                                        } catch (e) {
                                            console.error('解析流数据失败:', e, line);
                                        }
                                    }
                                }
                                
                                return processStream();
                            });
                        };
                        
                        return processStream();
                    })
                    .catch(error => {
                        console.error('翻译请求失败:', error);
                        this.isLoading = false;
                        this.$message.error('翻译请求失败，请重试');
                    });
                }
            },
            mounted() {
                this.getLanguages();
                this.getModels();
            }
        });
    </script>
</body>
</html>